<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø© ÙˆØ§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap RTL Ù…Ù† CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.rtl.min.css" />

  <style>
    body {
      background: #f5f5f5;
      padding: 20px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .card {
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      border-radius: 10px;
    }
    .badge-present {
      background-color: #198754;
    }
    .badge-absent {
      background-color: #dc3545;
    }
    .loader {
      display: none;
    }
    .small-label {
      font-size: 0.85rem;
      color: #555;
    }
  </style>
</head>
<body>

  <div class="container">

    <h2 class="mb-4 text-center">Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø© ÙˆØ§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± - Ù…Ø±Ø¨ÙˆØ· Ø¨Ù€ Google Sheet</h2>

    <!-- âœ… Ø¬Ø²Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginSection" class="row justify-content-center">
      <div class="col-md-5">
        <div class="card">
          <div class="card-header text-center">
            <strong>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</strong>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="loginUsername" class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
              <input type="text" id="loginUsername" class="form-control" placeholder="Username">
            </div>
            <div class="mb-3">
              <label for="loginPassword" class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
              <input type="password" id="loginPassword" class="form-control" placeholder="Password">
            </div>
            <button id="loginBtn" class="btn btn-primary w-100">Ø¯Ø®ÙˆÙ„</button>
            <div id="loginMessage" class="mt-3"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- âœ… Ø§Ù„Ø³ÙŠØ³ØªÙ… Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="appSection" class="row g-4" style="display:none;">

      <div class="col-12 mb-2">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong>
            <span id="userInfo"></span>
          </div>
          <button id="logoutBtn" class="btn btn-sm btn-outline-danger">
            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
          </button>
        </div>
      </div>

      <!-- ÙÙˆØ±Ù… Ø­Ø¶ÙˆØ± Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø© -->
      <div class="col-lg-4">
        <div class="card">
          <div class="card-header">
            <strong>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± / Ø§Ù†ØµØ±Ø§Ù Ø¯ÙƒØªÙˆØ±</strong>
          </div>
          <div class="card-body">
            <div class="mb-2 small-label">
              (Ù„Ùˆ Ø§Ù„ÙŠÙˆØ²Ø± Ø¯ÙƒØªÙˆØ±ØŒ Ù‡ÙŠØ«Ø¨Ù‘Øª Ø¹Ù„Ù‰ Ù†ÙØ³Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)
            </div>
            <div class="mb-3">
              <label for="doctorSelect" class="form-label">Ø§Ø®ØªØ§Ø± Ø§Ù„Ø¯ÙƒØªÙˆØ±</label>
              <select id="doctorSelect" class="form-select">
                <option value="">-- Ø§Ø®ØªØ± --</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©</label>
              <div class="d-flex gap-3">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="action" id="actionCheckIn" value="Check-in" checked>
                  <label class="form-check-label" for="actionCheckIn">Ø­Ø¶ÙˆØ± (Check-in)</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="action" id="actionCheckOut" value="Check-out">
                  <label class="form-check-label" for="actionCheckOut">Ø§Ù†ØµØ±Ø§Ù (Check-out)</label>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="sourceInput" class="form-label">Ù…ØµØ¯Ø± Ø§Ù„Ø­Ø±ÙƒØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input type="text" id="sourceInput" class="form-control" placeholder="Ù…Ø«Ø§Ù„: doctor / branch_manager / call_center">
            </div>

            <button id="submitBtn" class="btn btn-primary w-100">
              ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø¯ÙƒØªÙˆØ±
            </button>

            <div id="formMessage" class="mt-3"></div>
          </div>
        </div>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
      <div class="col-lg-8">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø© Ø§Ù„Ø¢Ù†</strong>
            <div>
              <button id="refreshBtn" class="btn btn-sm btn-outline-secondary">
                ØªØ­Ø¯ÙŠØ«
              </button>
              <span class="loader ms-2" id="statusLoader">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«...</span>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover align-middle">
                <thead>
                  <tr>
                    <th>Ø§Ù„ÙƒÙˆØ¯</th>
                    <th>Ø§Ø³Ù… Ø§Ù„Ø¯ÙƒØªÙˆØ±</th>
                    <th>Ø§Ù„ÙØ±Ø¹</th>
                    <th>Ø§Ù„ØªØ®ØµØµ</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø¢Ø®Ø± Ø­Ø±ÙƒØ©</th>
                    <th>Ø¢Ø®Ø± ÙˆÙ‚Øª</th>
                  </tr>
                </thead>
                <tbody id="statusTableBody">
                  <tr>
                    <td colspan="7" class="text-center">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ÙƒØ§Ø±Øª Ø­Ø¶ÙˆØ± Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± (Ù„Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± Ù†ÙØ³Ù‡Ù… ÙˆØ§Ù„Ù€ Admin) -->
      <div class="col-lg-4" id="ccAttendanceCard" style="display:none;">
        <div class="card">
          <div class="card-header">
            <strong>Ø­Ø¶ÙˆØ± Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± (Ù„Ù†ÙØ³ Ø§Ù„ÙŠÙˆØ²Ø±)</strong>
          </div>
          <div class="card-body">
            <div class="mb-3 small-label">
              Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¯ÙŠ Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù‡Ø§ÙŠØ© Ø´ÙŠÙØª Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± Ù„Ù†ÙØ³ Ø§Ù„ÙŠÙˆØ²Ø±.
            </div>
            <div class="d-grid gap-2 mb-3">
              <button id="ccCheckInBtn" class="btn btn-success">Ø¨Ø¯Ø¡ Ø´ÙŠÙØª (Check-in)</button>
              <button id="ccCheckOutBtn" class="btn btn-outline-danger">Ø¥Ù†Ù‡Ø§Ø¡ Ø´ÙŠÙØª (Check-out)</button>
            </div>
            <div id="ccAttendanceMessage" class="mt-2"></div>
          </div>
        </div>
      </div>

      <!-- ÙƒØ§Ø±Øª Ø­Ø§Ù„Ø© ÙŠÙˆØ²Ø±Ø§Øª Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± (Ù„Ù„Ù€ Admin) -->
      <div class="col-lg-8" id="callCenterStatusCard" style="display:none;">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Ø­Ø§Ù„Ø© ÙŠÙˆØ²Ø±Ø§Øª Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ±</strong>
            <button id="refreshCCStatusBtn" class="btn btn-sm btn-outline-secondary">ØªØ­Ø¯ÙŠØ«</button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover align-middle">
                <thead>
                  <tr>
                    <th>Username</th>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø¢Ø®Ø± Ø­Ø±ÙƒØ©</th>
                    <th>Ø¢Ø®Ø± ÙˆÙ‚Øª</th>
                  </tr>
                </thead>
                <tbody id="callCenterStatusTableBody">
                  <tr>
                    <td colspan="5" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ÙƒØ§Ø±Øª ÙŠÙˆØ²Ø±Ø§Øª Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± (Ù„Ù€ Admin ÙÙ‚Ø·) -->
      <div class="col-12" id="callCenterCard" style="display:none;">
        <div class="card">
          <div class="card-header">
            <strong>ÙŠÙˆØ²Ø±Ø§Øª Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ±</strong>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover align-middle">
                <thead>
                  <tr>
                    <th>Username</th>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø§Ù„Ù€ Role</th>
                  </tr>
                </thead>
                <tbody id="callCenterTableBody">
                  <tr>
                    <td colspan="3" class="text-center">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ÙƒØ§Ø±Øª Ø§Ù„Ù€ Cases (Ù„Ù€ call_center + admin) -->
      <div class="col-12" id="casesCard" style="display:none;">
        <div class="card">
          <div class="card-header">
            <strong>Ø§Ù„Ø­Ø§Ù„Ø§Øª (Cases) - Ø±Ø¨Ø· Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± Ø¨Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø©</strong>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <!-- ÙÙˆØ±Ù… Ø¥Ù†Ø´Ø§Ø¡ Case -->
              <div class="col-lg-4">
                <h6>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h6>
                <div class="mb-2">
                  <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</label>
                  <input type="text" id="casePatientName" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶">
                </div>
                <div class="mb-2">
                  <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
                  <input type="text" id="casePatientPhone" class="form-control" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„">
                </div>
                <div class="mb-2">
                  <label class="form-label">Ø§Ù„ÙØ±Ø¹</label>
                  <input type="text" id="caseBranch" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±">
                </div>
                <div class="mb-2">
                  <label class="form-label">Ø§Ù„ØªØ®ØµØµ</label>
                  <input type="text" id="caseSpecialty" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ù‚Ù„Ø¨ØŒ Ø£Ø´Ø¹Ø©...">
                </div>
                <div class="mb-2">
                  <label class="form-label">Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙƒØªÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                  <select id="caseDoctorSelect" class="form-select">
                    <option value="">Ø¨Ø¯ÙˆÙ† (ØªØªØ­Ø¯Ø¯ Ù„Ø§Ø­Ù‚Ù‹Ø§)</option>
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
                  <select id="casePriority" class="form-select">
                    <option value="normal">Normal</option>
                    <option value="high">High</option>
                    <option value="low">Low</option>
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label">Ù‚Ù†Ø§Ø© Ø§Ù„Ø§ØªØµØ§Ù„</label>
                  <select id="caseSourceChannel" class="form-select">
                    <option value="phone">Phone</option>
                    <option value="whatsapp">WhatsApp</option>
                    <option value="referral">Referral</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                  <textarea id="caseNotes" class="form-control" rows="3"></textarea>
                </div>
                <button id="createCaseBtn" class="btn btn-success w-100 mt-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©</button>
                <div id="caseFormMessage" class="mt-2"></div>
              </div>

              <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª -->
              <div class="col-lg-8">
                <h6>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª</h6>
                <div class="d-flex justify-content-end mb-2">
                  <button id="refreshCasesBtn" class="btn btn-sm btn-outline-secondary">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª</button>
                </div>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                  <table class="table table-striped table-hover align-middle">
                    <thead>
                      <tr>
                        <th>CaseID</th>
                        <th>ÙˆÙ‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                        <th>Ø§Ù„Ù…Ø±ÙŠØ¶</th>
                        <th>Ù…ÙˆØ¨Ø§ÙŠÙ„</th>
                        <th>Ø§Ù„ÙØ±Ø¹</th>
                        <th>Ø§Ù„Ø¯ÙƒØªÙˆØ±</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Priority</th>
                      </tr>
                    </thead>
                    <tbody id="casesTableBody">
                      <tr>
                        <td colspan="8" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ø¨Ø¹Ø¯.</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

    </div>

  </div>

  <script>
    // Ù…ØªØºÙŠØ±Ø§Øª Ø¬Ù„ÙˆØ¨Ø§Ù„
    var currentUser = null;
    var allDoctors = [];

    // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    function loadDoctors() {
      google.script.run
        .withSuccessHandler(function (doctors) {
          allDoctors = doctors || [];
          var doctorSelect = document.getElementById('doctorSelect');
          var caseDoctorSelect = document.getElementById('caseDoctorSelect');

          if (doctorSelect) {
            doctorSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± --</option>';
          }
          if (caseDoctorSelect) {
            caseDoctorSelect.innerHTML = '<option value="">Ø¨Ø¯ÙˆÙ† (ØªØªØ­Ø¯Ø¯ Ù„Ø§Ø­Ù‚Ù‹Ø§)</option>';
          }

          allDoctors.forEach(function (doc) {
            if (doctorSelect) {
              var option1 = document.createElement('option');
              option1.value = doc.id;
              option1.textContent = doc.name + ' - ' + doc.branch + ' (' + doc.specialty + ')';
              doctorSelect.appendChild(option1);
            }

            if (caseDoctorSelect) {
              var option2 = document.createElement('option');
              option2.value = doc.id;
              option2.textContent = doc.name + ' - ' + doc.branch + ' (' + doc.specialty + ')';
              caseDoctorSelect.appendChild(option2);
            }
          });

          // Ù„Ùˆ Ø§Ù„ÙŠÙˆØ²Ø± Ø¯ÙƒØªÙˆØ±ØŒ Ø«Ø¨Ù‘Øª Ù„Ù‡ Ø§Ù„Ø¯ÙƒØªÙˆØ± Ø¨ØªØ§Ø¹Ù‡
          if (currentUser && currentUser.role === 'doctor' && currentUser.doctorId) {
            if (doctorSelect) {
              doctorSelect.value = currentUser.doctorId;
              doctorSelect.disabled = true;
            }
          } else {
            if (doctorSelect) {
              doctorSelect.disabled = false;
            }
          }
        })
        .withFailureHandler(function (err) {
          console.error(err);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø©.');
        })
        .getDoctors();
    }

    // ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    function loadCurrentStatus() {
      var loader = document.getElementById('statusLoader');
      if (loader) loader.style.display = 'inline';

      google.script.run
        .withSuccessHandler(function (statusList) {
          if (loader) loader.style.display = 'none';
          var tbody = document.getElementById('statusTableBody');
          if (!tbody) return;

          tbody.innerHTML = '';

          if (!statusList || statusList.length === 0) {
            var row = document.createElement('tr');
            var cell = document.createElement('td');
            cell.colSpan = 7;
            cell.className = 'text-center';
            cell.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.';
            row.appendChild(cell);
            tbody.appendChild(row);
            return;
          }

          statusList.forEach(function (doc) {
            var row = document.createElement('tr');

            var tdId = document.createElement('td');
            tdId.textContent = doc.id;
            row.appendChild(tdId);

            var tdName = document.createElement('td');
            tdName.textContent = doc.name;
            row.appendChild(tdName);

            var tdBranch = document.createElement('td');
            tdBranch.textContent = doc.branch;
            row.appendChild(tdBranch);

            var tdSpec = document.createElement('td');
            tdSpec.textContent = doc.specialty;
            row.appendChild(tdSpec);

            var tdStatus = document.createElement('td');
            var spanStatus = document.createElement('span');
            spanStatus.classList.add('badge');
            if (doc.status === 'Present') {
              spanStatus.classList.add('badge-present');
              spanStatus.textContent = 'ğŸŸ¢ Ù…ÙˆØ¬ÙˆØ¯';
            } else {
              spanStatus.classList.add('badge-absent');
              spanStatus.textContent = 'ğŸ”´ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
            }
            tdStatus.appendChild(spanStatus);
            row.appendChild(tdStatus);

            var tdLastAction = document.createElement('td');
            tdLastAction.textContent = doc.lastAction === 'â€”'
              ? 'â€”'
              : (doc.lastAction === 'Check-in' ? 'Ø­Ø¶ÙˆØ±' : 'Ø§Ù†ØµØ±Ø§Ù');
            row.appendChild(tdLastAction);

            var tdLastTime = document.createElement('td');
            tdLastTime.textContent = doc.lastTime || 'â€”';
            row.appendChild(tdLastTime);

            tbody.appendChild(row);
          });
        })
        .withFailureHandler(function (err) {
          if (loader) loader.style.display = 'none';
          console.error(err);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø©.');
        })
        .getCurrentStatus();
    }

    // ØªØ­Ù…ÙŠÙ„ ÙŠÙˆØ²Ø±Ø§Øª Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± (Ù„Ù€ Admin ÙÙ‚Ø·)
    function loadCallCenterUsers() {
      var tbody = document.getElementById('callCenterTableBody');
      if (!tbody) return;

      tbody.innerHTML = '<tr><td colspan="3" class="text-center">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>';

      google.script.run
        .withSuccessHandler(function (users) {
          tbody.innerHTML = '';

          if (!users || users.length === 0) {
            var row = document.createElement('tr');
            var cell = document.createElement('td');
            cell.colSpan = 3;
            cell.className = 'text-center';
            cell.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙŠÙˆØ²Ø±Ø§Øª ÙƒÙˆÙ„ Ø³Ù†ØªØ±.';
            row.appendChild(cell);
            tbody.appendChild(row);
            return;
          }

          users.forEach(function (u) {
            var row = document.createElement('tr');

            var tdUser = document.createElement('td');
            tdUser.textContent = u.username;
            row.appendChild(tdUser);

            var tdName = document.createElement('td');
            tdName.textContent = u.name;
            row.appendChild(tdName);

            var tdRole = document.createElement('td');
            tdRole.textContent = u.role;
            row.appendChild(tdRole);

            tbody.appendChild(row);
          });
        })
        .withFailureHandler(function (err) {
          console.error(err);
          tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ÙŠÙˆØ²Ø±Ø§Øª Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ±.</td></tr>';
        })
        .getCallCenterUsers();
    }

    // ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± (Ù…ÙŠÙ† Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†)
    function loadCallCenterStatus() {
      var tbody = document.getElementById('callCenterStatusTableBody');
      if (!tbody) return;

      tbody.innerHTML = '<tr><td colspan="5" class="text-center">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>';

      google.script.run
        .withSuccessHandler(function (list) {
          tbody.innerHTML = '';

          if (!list || list.length === 0) {
            var row = document.createElement('tr');
            var cell = document.createElement('td');
            cell.colSpan = 5;
            cell.className = 'text-center';
            cell.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.';
            row.appendChild(cell);
            tbody.appendChild(row);
            return;
          }

          list.forEach(function (u) {
            var row = document.createElement('tr');

            var tdUser = document.createElement('td');
            tdUser.textContent = u.username;
            row.appendChild(tdUser);

            var tdName = document.createElement('td');
            tdName.textContent = u.name;
            row.appendChild(tdName);

            var tdStatus = document.createElement('td');
            var spanStatus = document.createElement('span');
            spanStatus.classList.add('badge');
            if (u.status === 'Present') {
              spanStatus.classList.add('badge-present');
              spanStatus.textContent = 'ğŸŸ¢ Ù…ÙˆØ¬ÙˆØ¯';
            } else {
              spanStatus.classList.add('badge-absent');
              spanStatus.textContent = 'ğŸ”´ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
            }
            tdStatus.appendChild(spanStatus);
            row.appendChild(tdStatus);

            var tdLastAction = document.createElement('td');
            tdLastAction.textContent = u.lastAction === 'â€”'
              ? 'â€”'
              : (u.lastAction === 'Check-in' ? 'Ø¨Ø¯Ø¡ Ø´ÙŠÙØª' : 'Ù†Ù‡Ø§ÙŠØ© Ø´ÙŠÙØª');
            row.appendChild(tdLastAction);

            var tdLastTime = document.createElement('td');
            tdLastTime.textContent = u.lastTime || 'â€”';
            row.appendChild(tdLastTime);

            tbody.appendChild(row);
          });
        })
        .withFailureHandler(function (err) {
          console.error(err);
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ±.</td></tr>';
        })
        .getCallCenterStatus();
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø­Ø¶ÙˆØ± / Ø§Ù†ØµØ±Ø§Ù Ø¯ÙƒØªÙˆØ±
    function submitAttendance() {
      var doctorId = document.getElementById('doctorSelect').value;
      var action = document.querySelector('input[name="action"]:checked').value;
      var source = document.getElementById('sourceInput').value || '';

      var msgDiv = document.getElementById('formMessage');
      msgDiv.innerHTML = '';
      msgDiv.className = '';

      if (!doctorId) {
        msgDiv.className = 'alert alert-warning';
        msgDiv.textContent = 'Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø¯ÙƒØªÙˆØ± Ø£ÙˆÙ„Ø§Ù‹.';
        return;
      }

      var submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';

      google.script.run
        .withSuccessHandler(function (res) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø¯ÙƒØªÙˆØ±';

          msgDiv.className = 'alert alert-success';
          msgDiv.textContent = res.message || 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.';

          loadCurrentStatus();
        })
        .withFailureHandler(function (err) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø¯ÙƒØªÙˆØ±';

          console.error(err);
          msgDiv.className = 'alert alert-danger';
          msgDiv.textContent = err.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.';
        })
        .submitAttendance(doctorId, action, source);
    }

    // Ø­Ø¶ÙˆØ± Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± (Ù„Ù†ÙØ³ Ø§Ù„ÙŠÙˆØ²Ø±)
    function submitCallCenterAttendance(action) {
      if (!currentUser || !currentUser.username) {
        alert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø§Ù„ÙŠ.');
        return;
      }

      var msgDiv = document.getElementById('ccAttendanceMessage');
      msgDiv.innerHTML = '';
      msgDiv.className = '';

      google.script.run
        .withSuccessHandler(function (res) {
          msgDiv.className = 'alert alert-success';
          msgDiv.textContent = res.message || 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.';
          loadCallCenterStatus();
        })
        .withFailureHandler(function (err) {
          console.error(err);
          msgDiv.className = 'alert alert-danger';
          msgDiv.textContent = err.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.';
        })
        .submitCallCenterAttendance(currentUser.username, action, 'web');
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Case Ø¬Ø¯ÙŠØ¯Ø©
    function createCase() {
      if (!currentUser) {
        alert('Ø¨Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }

      var patientName = document.getElementById('casePatientName').value.trim();
      var patientPhone = document.getElementById('casePatientPhone').value.trim();
      var branch = document.getElementById('caseBranch').value.trim();
      var specialty = document.getElementById('caseSpecialty').value.trim();
      var doctorId = document.getElementById('caseDoctorSelect').value;
      var priority = document.getElementById('casePriority').value;
      var src = document.getElementById('caseSourceChannel').value;
      var notes = document.getElementById('caseNotes').value.trim();

      var msgDiv = document.getElementById('caseFormMessage');
      msgDiv.innerHTML = '';
      msgDiv.className = '';

      if (!patientName || !patientPhone) {
        msgDiv.className = 'alert alert-warning';
        msgDiv.textContent = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†.';
        return;
      }

      var btn = document.getElementById('createCaseBtn');
      btn.disabled = true;
      btn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';

      google.script.run
        .withSuccessHandler(function (res) {
          btn.disabled = false;
          btn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©';

          msgDiv.className = 'alert alert-success';
          msgDiv.textContent = res.message || 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­.';

          // ØªÙØ±ÙŠØº Ø§Ù„ÙÙˆØ±Ù… Ø§Ù„Ø¨Ø³ÙŠØ·
          document.getElementById('casePatientName').value = '';
          document.getElementById('casePatientPhone').value = '';
          document.getElementById('caseBranch').value = '';
          document.getElementById('caseSpecialty').value = '';
          document.getElementById('caseDoctorSelect').value = '';
          document.getElementById('caseNotes').value = '';
          document.getElementById('casePriority').value = 'normal';
          document.getElementById('caseSourceChannel').value = 'phone';

          loadCases();
        })
        .withFailureHandler(function (err) {
          btn.disabled = false;
          btn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©';

          console.error(err);
          msgDiv.className = 'alert alert-danger';
          msgDiv.textContent = err.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©.';
        })
        .createCase(patientName, patientPhone, branch, specialty, doctorId, notes, priority, src, currentUser.username);
    }

    // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª
    function loadCases() {
      var tbody = document.getElementById('casesTableBody');
      if (!tbody) return;

      tbody.innerHTML = '<tr><td colspan="8" class="text-center">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª...</td></tr>';

      google.script.run
        .withSuccessHandler(function (cases) {
          tbody.innerHTML = '';

          if (!cases || cases.length === 0) {
            var row = document.createElement('tr');
            var cell = document.createElement('td');
            cell.colSpan = 8;
            cell.className = 'text-center';
            cell.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª.';
            row.appendChild(cell);
            tbody.appendChild(row);
            return;
          }

          cases.forEach(function (c) {
            var row = document.createElement('tr');

            var tdId = document.createElement('td');
            tdId.textContent = c.caseId;
            row.appendChild(tdId);

            var tdTs = document.createElement('td');
            tdTs.textContent = c.timestamp;
            row.appendChild(tdTs);

            var tdPName = document.createElement('td');
            tdPName.textContent = c.patientName;
            row.appendChild(tdPName);

            var tdPPhone = document.createElement('td');
            tdPPhone.textContent = c.patientPhone;
            row.appendChild(tdPPhone);

            var tdBranch = document.createElement('td');
            tdBranch.textContent = c.branch;
            row.appendChild(tdBranch);

            var tdDoc = document.createElement('td');
            tdDoc.textContent = c.doctorName || c.doctorId || 'Ù„Ù… ÙŠØ­Ø¯Ø¯ Ø¨Ø¹Ø¯';
            row.appendChild(tdDoc);

            var tdStatus = document.createElement('td');
            tdStatus.textContent = c.status;
            row.appendChild(tdStatus);

            var tdPrio = document.createElement('td');
            tdPrio.textContent = c.priority;
            row.appendChild(tdPrio);

            tbody.appendChild(row);
          });
        })
        .withFailureHandler(function (err) {
          console.error(err);
          tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª.</td></tr>';
        })
        .getCases();
    }

    // âœ… Login function
    function login() {
      var username = document.getElementById('loginUsername').value.trim();
      var password = document.getElementById('loginPassword').value;
      var msgDiv = document.getElementById('loginMessage');

      msgDiv.innerHTML = '';
      msgDiv.className = '';

      if (!username || !password) {
        msgDiv.className = 'alert alert-warning';
        msgDiv.textContent = 'Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.';
        return;
      }

      var loginBtn = document.getElementById('loginBtn');
      loginBtn.disabled = true;
      loginBtn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø¯Ø®ÙˆÙ„...';

      google.script.run
        .withSuccessHandler(function (res) {
          loginBtn.disabled = false;
          loginBtn.textContent = 'Ø¯Ø®ÙˆÙ„';

          currentUser = res.user;
          try {
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
          } catch (e) {}

          msgDiv.className = 'alert alert-success';
          msgDiv.textContent = 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.';

          updateUIForUser();
          loadDoctors(); // Ø¨Ø¹Ø¯ Ù…Ø§ ÙŠØ¨Ù‚Ù‰ Ø¹Ù†Ø¯Ù†Ø§ currentUser
          loadCurrentStatus();
          loadCases();
          if (currentUser.role === 'admin') {
            loadCallCenterUsers();
            loadCallCenterStatus();
          }
        })
        .withFailureHandler(function (err) {
          loginBtn.disabled = false;
          loginBtn.textContent = 'Ø¯Ø®ÙˆÙ„';

          console.error(err);
          msgDiv.className = 'alert alert-danger';
          msgDiv.textContent = err.message || 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.';
        })
        .loginUser(username, password);
    }

    // âœ… Logout
    function logout() {
      currentUser = null;
      try {
        localStorage.removeItem('currentUser');
      } catch (e) {}
      updateUIForUser();
    }

    // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„Ø®Ø±ÙˆØ¬
    function updateUIForUser() {
      var loginSection = document.getElementById('loginSection');
      var appSection = document.getElementById('appSection');
      var userInfoSpan = document.getElementById('userInfo');
      var callCenterCard = document.getElementById('callCenterCard');
      var ccAttendanceCard = document.getElementById('ccAttendanceCard');
      var callCenterStatusCard = document.getElementById('callCenterStatusCard');
      var casesCard = document.getElementById('casesCard');

      if (currentUser) {
        loginSection.style.display = 'none';
        appSection.style.display = 'flex';

        userInfoSpan.textContent = currentUser.displayName + ' (' + currentUser.role + ')';

        // ÙƒØ§Ø±Øª Ø­Ø¶ÙˆØ± Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± Ù„Ù†ÙØ³Ù‡
        if (currentUser.role === 'call_center' || currentUser.role === 'admin') {
          if (ccAttendanceCard) ccAttendanceCard.style.display = 'block';
        } else {
          if (ccAttendanceCard) ccAttendanceCard.style.display = 'none';
        }

        // ÙƒØ§Ø±Øª Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± (Ø­Ø¶ÙˆØ± ÙŠÙˆØ²Ø±Ø§Øª Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ±) + ÙƒØ§Ø±Øª Ù‚Ø§Ø¦Ù…Ø© ÙŠÙˆØ²Ø±Ø§Øª Ø§Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± Ù„Ù„Ù€ Admin ÙÙ‚Ø·
        if (currentUser.role === 'admin') {
          if (callCenterStatusCard) callCenterStatusCard.style.display = 'block';
          if (callCenterCard) callCenterCard.style.display = 'block';
        } else {
          if (callCenterStatusCard) callCenterStatusCard.style.display = 'none';
          if (callCenterCard) callCenterCard.style.display = 'none';
        }

        // ÙƒØ§Ø±Øª Ø§Ù„Ù€ Cases Ù„Ù„ÙƒÙˆÙ„ Ø³Ù†ØªØ± + Admin
        if (currentUser.role === 'call_center' || currentUser.role === 'admin') {
          if (casesCard) casesCard.style.display = 'block';
        } else {
          if (casesCard) casesCard.style.display = 'none';
        }

      } else {
        loginSection.style.display = 'flex';
        appSection.style.display = 'none';
        userInfoSpan.textContent = '';

        if (callCenterCard) callCenterCard.style.display = 'none';
        if (ccAttendanceCard) ccAttendanceCard.style.display = 'none';
        if (callCenterStatusCard) callCenterStatusCard.style.display = 'none';
        if (casesCard) casesCard.style.display = 'none';
      }
    }

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', function () {
      var saved = null;
      try {
        saved = localStorage.getItem('currentUser');
      } catch (e) {
        saved = null;
      }

      if (saved) {
        try {
          currentUser = JSON.parse(saved);
        } catch (e) {
          currentUser = null;
        }
      }

      // Ù†Ø­Ù…Ù‘Ù„ Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø© Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§
      loadDoctors();
      updateUIForUser();
      if (currentUser) {
        loadCurrentStatus();
        if (currentUser.role === 'admin') {
          loadCallCenterUsers();
          loadCallCenterStatus();
        }
        if (currentUser.role === 'admin' || currentUser.role === 'call_center') {
          loadCases();
        }
      }

      // Listeners
      var loginBtn = document.getElementById('loginBtn');
      if (loginBtn) loginBtn.addEventListener('click', login);

      var logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) logoutBtn.addEventListener('click', logout);

      var submitBtn = document.getElementById('submitBtn');
      if (submitBtn) submitBtn.addEventListener('click', submitAttendance);

      var refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) refreshBtn.addEventListener('click', loadCurrentStatus);

      var ccInBtn = document.getElementById('ccCheckInBtn');
      if (ccInBtn) ccInBtn.addEventListener('click', function () {
        submitCallCenterAttendance('Check-in');
      });

      var ccOutBtn = document.getElementById('ccCheckOutBtn');
      if (ccOutBtn) ccOutBtn.addEventListener('click', function () {
        submitCallCenterAttendance('Check-out');
      });

      var refreshCCStatusBtn = document.getElementById('refreshCCStatusBtn');
      if (refreshCCStatusBtn) refreshCCStatusBtn.addEventListener('click', loadCallCenterStatus);

      var createCaseBtn = document.getElementById('createCaseBtn');
      if (createCaseBtn) createCaseBtn.addEventListener('click', createCase);

      var refreshCasesBtn = document.getElementById('refreshCasesBtn');
      if (refreshCasesBtn) refreshCasesBtn.addEventListener('click', loadCases);

      // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ùˆ ÙÙŠÙ‡ ÙŠÙˆØ²Ø±
      setInterval(function () {
        if (currentUser) {
          loadCurrentStatus();
          if (currentUser.role === 'admin') {
            loadCallCenterStatus();
          }
          if (currentUser.role === 'admin' || currentUser.role === 'call_center') {
            loadCases();
          }
        }
      }, 60000);
    });
  </script>

</body>
</html>
